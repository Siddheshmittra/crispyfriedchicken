<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CRISPR-All Design Lab</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://clinicaltables.nlm.nih.gov/autocomplete-lhc-versions/19.2.4/autocomplete-lhc.min.css" rel="stylesheet">
<script src="https://clinicaltables.nlm.nih.gov/autocomplete-lhc-versions/19.2.4/autocomplete-lhc.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --stanford-red:#8C1515;
  --stanford-light-red:#B83A4B;
  --white-color:#FFFFFF;
}

body {
  font-family:'Inter',sans-serif;
  background:#fff;
  color:var(--stanford-red);
  margin:0;
  padding:40px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}

.main-container {
  width:100%;
  max-width:900px;
  background:var(--stanford-red);
  border-radius:16px;
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
  padding:48px;
  border-top:8px solid var(--stanford-light-red);
}

h1,h2 {color:var(--white-color);font-weight:600;}
h1 {font-size:32px;}
h2 {font-size:22px;margin-bottom:16px;border-bottom:2px solid rgba(255,255,255,0.3);padding-bottom:8px;}
h3 {font-size:18px;font-weight:600;color:white;margin:24px 0 12px;}
.section {margin-bottom:32px;}
.header {display:flex;align-items:center;margin-bottom:16px;}
.logo {background:var(--white-color);color:var(--stanford-red);font-size:24px;font-weight:700;border-radius:8px;padding:10px 16px;margin-right:16px;}
.description {font-size:16px;color:rgba(255,255,255,0.9);margin-bottom:32px;max-width:700px;}
.radio-group label {margin-right:24px;font-size:16px;cursor:pointer;color:var(--white-color);}

input,select,textarea {color:#fff !important;}
input::placeholder,textarea::placeholder {color:#fff;opacity:.7;}

#natural-language-input {
  width:100%;padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.1);color:var(--white-color);font-size:16px;margin-top:16px;
}

.reasoning-container {text-align:center;color:rgba(255,255,255,0.8);font-style:italic;margin-top:14px;}
.dots {display:inline-block;}
.dots span {display:inline-block;width:10px;height:10px;background:rgba(255,255,255,0.8);border-radius:50%;margin:0 3px;animation:dot-pulse 1.4s infinite ease-in-out both;}
.dots span:nth-child(1){animation-delay:-0.32s;}
.dots span:nth-child(2){animation-delay:-0.16s;}
@keyframes dot-pulse {0%,80%,100%{transform:scale(0);}40%{transform:scale(1);} }

.perturbation-list {list-style:none;padding:0;margin:0 0 8px;}
.perturbation-list>li {
  font-size:18px;margin-bottom:12px;display:flex;align-items:center;cursor:pointer;
  padding:8px;border-radius:6px;transition:background-color .2s;color:#fff !important;
}
.perturbation-list>li:hover {background:rgba(255,255,255,0.1);}
.perturbation-list>li.active {background:var(--white-color);color:var(--stanford-red) !important;}
.perturbation-list>li::before {content:'â–¶';margin-right:12px;font-size:14px;transition:transform .2s;color:#fff;}
.perturbation-list>li.active::before {transform:rotate(90deg);color:var(--stanford-red);}

.module-container {
  border:2px dashed rgba(255,255,255,0.3);border-radius:8px;padding:16px;min-height:100px;
  background:rgba(255,255,255,0.1);margin:0 0 16px;
}

.gene-module {
  background:var(--white-color);color:var(--stanford-red);padding:10px 16px;border-radius:6px;cursor:grab;
  font-weight:500;display:inline-block;text-align:center;user-select:none;margin:4px;position:relative;
}

#construct-builder {
  border:2px dashed rgba(255,255,255,0.3);border-radius:8px;padding:16px;width:100%;min-height:100px;
  display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:10px;background:rgba(255,255,255,0.1);
}

.placeholder {color:rgba(255,255,255,0.7);text-align:center;width:100%;}
.construct-header {display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}

.button {
  background:var(--white-color);color:var(--stanford-red);border:none;border-radius:8px;padding:10px 18px;
  font-size:15px;font-weight:500;cursor:pointer;transition:background-color .3s;
}
.button:hover {background:rgba(255,255,255,0.9);}
.button.secondary {background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);}
.button.secondary:hover {background:rgba(255,255,255,0.3);}

.hidden {display:none !important;}

.form-row {display:flex;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap;}
.form-row label {color:white;flex-shrink:0;width:150px;}
.form-row input,.form-row select {
  flex-grow:1;padding:6px 10px;border-radius:4px;border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.1);
}

#cassette-string {
  width:100%;min-height:40px;margin-top:6px;font-family:monospace;font-size:15px;
  border-radius:6px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:white;
}

#final-construct-details p {
  background:rgba(255,255,255,0.1);padding:12px;border-radius:6px;font-style:italic;
  color:rgba(255,255,255,0.9);margin-top:5px;
}

#final-sequence-output {
  font-family:monospace;word-break:break-all;background:rgba(255,255,255,0.1);
  padding:12px;border-radius:6px;min-height:120px;border:1px solid rgba(255,255,255,0.2);
  color:white;line-height:1.4;
}
.gene-seq {cursor:help;padding:2px 4px;margin:0 2px;border-radius:3px;display:inline-block;}
.gene-seq:hover {background:rgba(255,255,255,0.2);}

.gene-remove-btn {
  position:absolute;right:-8px;top:-8px;background:#fff;border:1px solid #ccc;border-radius:50%;
  width:20px;height:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;line-height:1;color:var(--stanford-red);
}

.connector-select {
  background:#fff;color:var(--stanford-red);border-radius:4px;border:1px solid #ccc;
  padding:2px 4px;font-size:12px;margin:0 4px;cursor:pointer;
}
.connector-wrapper {display:flex;align-items:center;gap:4px;}
.connector-label {color:#fff;font-size:12px;font-weight:600;}

#library-output-list {
  list-style:none;padding:0;margin-top:16px;max-height:300px;overflow-y:auto;
  background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;
}
#library-output-list li {
  padding:10px 12px;background:rgba(255,255,255,0.1);margin-bottom:6px;border-radius:6px;
  cursor:pointer;transition:background-color .2s;color:white;font-family:monospace;
}
#library-output-list li:hover {background:rgba(255,255,255,0.2);}

.limit-warning {
  background:#fff;color:var(--stanford-red);padding:6px 10px;border-radius:6px;
  font-size:13px;font-weight:600;margin-top:10px;display:none;
}
.inline-mode-toggle {margin:12px 0 8px;display:flex;gap:20px;color:#fff;font-size:14px;}
.inline-mode-toggle label {cursor:pointer;}
.autocomplete-suggestions{ z-index:10000 !important; position:absolute; background:#fff; color:#8C1515; border:1px solid #ccc; border-radius:6px; width:100%; max-height:220px; overflow-y:auto; box-shadow:0 4px 16px rgba(0,0,0,0.12); font-size:15px; padding:4px 0; }
.autocomplete-suggestion{ padding:8px 12px; cursor:pointer; transition:background 0.15s; }
.autocomplete-suggestion.active, .autocomplete-suggestion:hover{ background:#f5eaea; }
</style>
</head>
<body>
<div class="main-container">
  <div class="header">
    <div class="logo">S</div>
    <h1>CRISPR-ALL Design Lab</h1>
  </div>
  <p class="description">
    A tool to design modular, combinatorial genetic perturbations in primary human T cells. (Courtesy of the lab of Dr. Theodore Roth)
  </p>

  <!-- Global mode -->
  <div class="section">
    <h2>1. Design Mode</h2>
    <div class="radio-group">
      <input type="radio" id="natural-language-mode" name="design-mode" value="natural">
      <label for="natural-language-mode">Natural Language</label>
      <input type="radio" id="manual-mode" name="design-mode" value="manual" checked>
      <label for="manual-mode">Manual</label>
      <input type="radio" id="multi-cassette-mode" name="design-mode" value="multi">
      <label for="multi-cassette-mode">Multi-Cassette</label>
    </div>
    <div id="natural-language-container" class="hidden">
      <input type="text" id="natural-language-input" placeholder="e.g., 'Enhance persistence and cytotoxicity' (Enter)">
      <div id="reasoning-display" class="reasoning-container hidden">
        <p>Processing your request <span class="dots"><span></span><span></span><span></span></span></p>
      </div>
    </div>
  </div>

  <!-- Manual modules -->
  <div id="manual-tool-container">
    <div class="section">
      <h2>2. Select Modules</h2>
      <div id="gene-search-bar" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
        <div id="perturbation-type-toggles" style="display:flex;gap:10px;">
          <label style="color:white;font-size:15px;"><input type="checkbox" class="perturbation-type-toggle" value="KO" checked> KO</label>
          <label style="color:white;font-size:15px;"><input type="checkbox" class="perturbation-type-toggle" value="KI" checked> KI</label>
          <label style="color:white;font-size:15px;"><input type="checkbox" class="perturbation-type-toggle" value="KD" checked> KD</label>
          <label style="color:white;font-size:15px;"><input type="checkbox" class="perturbation-type-toggle" value="KU" checked> KU</label>
        </div>
        <input type="text" id="gene-search-input" placeholder="Search or enter gene symbol..." style="flex:1;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:white;font-size:15px;">
      </div>
      <div style="font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:8px;">Powered by NCBI GeneBank</div>
      <div id="ncbi-add-panel" style="display:none;margin-bottom:8px;"></div>
      <div id="no-gene-results" style="display:none;font-size:15px;color:#fff;background:rgba(140,21,21,0.7);padding:8px 12px;border-radius:6px;margin-bottom:8px;">No matching gene modules found in this library.</div>
      <div id="limit-warning" class="limit-warning">Limit reached (5 perturbations)</div>
      <ul class="perturbation-list">
        <li data-target="knock-in-modules">Knock-ins (Overexpression)</li>
        <div id="knock-in-modules" class="module-container hidden">
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="BATF">BATF</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="IRF4">IRF4</div>
            <div class="gene-module" draggable="true" data-type="overexpression" data-gene="c-Jun">c-Jun</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="IL-21">IL-21</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="dnPD-1">dnPD-1</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="BCL6">BCL6</div>
        </div>
        <li data-target="knock-out-modules">Knock-outs (Gene Disruption)</li>
        <div id="knock-out-modules" class="module-container hidden">
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KO:PDCD1">KO:PDCD1</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KO:CTLA4">KO:CTLA4</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KO:LAG3">KO:LAG3</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KO:DGK">KO:DGK</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KO:TET2">KO:TET2</div>
        </div>
        <li data-target="knock-down-modules">Knock-downs (CRISPRi)</li>
        <div id="knock-down-modules" class="module-container hidden">
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KD:SOCS1">KD:SOCS1</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KD:CBLB">KD:CBLB</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KD:NFKBIA">KD:NFKBIA</div>
          <div class="gene-module" draggable="true" data-type="gRNA" data-gene="KD:TGFBR1">KD:TGFBR1</div>
        </div>
        <li data-target="knock-up-modules">Knock-ups (CRISPRa)</li>
        <div id="knock-up-modules" class="module-container hidden">
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="KU:IL2RA">KU:IL2RA</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="KU:TBX21">KU:TBX21</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="KU:IFNG">KU:IFNG</div>
          <div class="gene-module" draggable="true" data-type="overexpression" data-gene="KU:GZMB">KU:GZMB</div>
        </div>
      </ul>
    </div>
  </div>

  <!-- Multi-cassette mode (with internal modes) -->
  <div id="multi-cassette-tool-container" class="hidden">
    <div class="section">
      <h2>Multi-Cassette Library</h2>
      <div class="inline-mode-toggle">
        <label><input type="radio" name="mc-mode" value="manual" checked> Manual</label>
        <label><input type="radio" name="mc-mode" value="nl"> Natural Language</label>
      </div>
      <div id="mc-manual-panel">
        <div class="form-row">
          <label for="num-cassettes"># of Cassettes:</label>
          <input id="num-cassettes" type="number" value="10" min="1" max="200">
        </div>
        <div class="form-row">
          <label for="num-modules">Modules per Cassette:</label>
          <input id="num-modules" type="number" value="3" min="1" max="5">
        </div>
        <div class="form-row">
          <label>Perturbation Types:</label>
          <div style="display:flex;gap:15px;flex-wrap:wrap;">
            <label style="width:auto;"><input type="checkbox" id="include-ki" checked> KI</label>
            <label style="width:auto;"><input type="checkbox" id="include-ko" checked> KO</label>
            <label style="width:auto;"><input type="checkbox" id="include-kd" checked> KD</label>
            <label style="width:auto;"><input type="checkbox" id="include-ku" checked> KU</label>
          </div>
        </div>
        <div style="text-align:right;margin-top:8px;">
          <button id="generate-library-btn" class="button">Generate</button>
        </div>
      </div>
      <div id="mc-nl-panel" class="hidden">
        <input id="mc-nl-input" type="text" placeholder="Describe the perturbation themes (e.g. 'memory + checkpoint resistance')" style="width:100%;padding:10px 14px;border-radius:6px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);">
        <div style="text-align:right;margin-top:10px;">
          <button id="mc-nl-generate" class="button">Generate Library (NL)</button>
        </div>
      </div>
      <div id="library-output-container" class="hidden">
        <h3>Generated Library</h3>
        <p style="color:rgba(255,255,255,0.8);font-size:14px;">Click a cassette to load into the builder.</p>
        <ul id="library-output-list"></ul>
      </div>
    </div>
  </div>

  <!-- Construct layout (ALWAYS visible) -->
  <div class="section">
    <div class="construct-header">
      <h2>3. Construct Layout</h2>
      <div style="display:flex;flex-wrap:wrap;gap:10px;">
        <button id="import-btn" class="button secondary">Import</button>
        <button id="randomize-btn" class="button">Randomize</button>
        <button id="reset-btn" class="button secondary">Reset</button>
        <input type="file" id="import-file-input" class="hidden" accept=".json">
      </div>
    </div>
    <div id="construct-builder" style="margin-top:16px;">
      <div class="placeholder">Select a module category, then drag genes here (max 5)</div>
    </div>
    <div style="margin-top:24px;">
      <label for="cassette-string" style="font-weight:500;color:white;">Cassette String:</label>
      <textarea id="cassette-string" readonly></textarea>
    </div>
    <div id="cassette-details" style="margin-top:24px;">
      <h3>Cassette Details</h3>
      <div class="form-row">
        <label for="promoter-select">Promoter:</label>
        <select id="promoter-select">
          <option value="EF1a">EF1a</option><option value="PGK">PGK</option>
          <option value="SFFV">SFFV</option><option value="CMV">CMV</option>
        </select>
      </div>
      <div class="form-row">
        <label for="left-homology">Left Homology Arm:</label>
        <input id="left-homology" type="text" placeholder="e.g. TRAC upstream">
      </div>
      <div class="form-row">
        <label for="right-homology">Right Homology Arm:</label>
        <input id="right-homology" type="text" placeholder="e.g. TRAC downstream">
      </div>
      <div class="form-row">
        <label for="barcode">Barcode:</label>
        <input id="barcode" type="text" placeholder="e.g. Unique 10-20bp">
      </div>
      <div class="form-row">
        <label for="polyA-select">PolyA Signal:</label>
        <select id="polyA-select">
          <option value="SV40">SV40</option><option value="bGH">bGH</option><option value="NOS">NOS</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Final construct (ALWAYS visible) -->
  <div class="section">
    <div class="construct-header">
      <h2>4. Final Construct</h2>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button id="toggle-sequence-btn" class="button secondary">Show Sequence</button>
        <button id="export-btn" class="button">Export</button>
      </div>
    </div>
    <div id="final-construct-details" class="hidden" style="margin-top:16px;">
      <div>
        <label style="color:white;font-weight:500;">Construct Name:</label>
        <p id="construct-name-output">N/A</p>
      </div>
      <div>
        <label style="color:white;font-weight:500;">Predicted Function:</label>
        <p id="predicted-function-output">Build a construct to see prediction.</p>
      </div>
      <div>
        <label style="color:white;font-weight:500;">Nucleotide Sequence:</label>
        <div id="final-sequence-output"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',() => {
  // Elements
  const modeToggles=document.querySelectorAll('input[name="design-mode"]');
  const naturalLanguageContainer=document.getElementById('natural-language-container');
  const naturalLanguageInput=document.getElementById('natural-language-input');
  const reasoningDisplay=document.getElementById('reasoning-display');

  const manualToolContainer=document.getElementById('manual-tool-container');
  const multiCassetteToolContainer=document.getElementById('multi-cassette-tool-container');

  const mcModeToggles=document.querySelectorAll('input[name="mc-mode"]');
  const mcManualPanel=document.getElementById('mc-manual-panel');
  const mcNlPanel=document.getElementById('mc-nl-panel');
  const mcNlInput=document.getElementById('mc-nl-input');

  const geneSearchInput=document.getElementById('gene-search-input');
  const moduleToggles=document.querySelectorAll('.perturbation-list > li[data-target]');
  const constructBuilder=document.getElementById('construct-builder');

  const randomizeBtn=document.getElementById('randomize-btn');
  const resetBtn=document.getElementById('reset-btn');
  const cassetteString=document.getElementById('cassette-string');
  const toggleSequenceBtn=document.getElementById('toggle-sequence-btn');
  const finalConstructDetails=document.getElementById('final-construct-details');
  const constructNameOutput=document.getElementById('construct-name-output');
  const predictedFunctionOutput=document.getElementById('predicted-function-output');
  const finalSequenceOutput=document.getElementById('final-sequence-output');
  const limitWarning=document.getElementById('limit-warning');
  const noGeneResults=document.getElementById('no-gene-results');
  const ncbiAddPanel = document.getElementById('ncbi-add-panel');
  let lastNcbiGene = null;

  const promoterSelect=document.getElementById('promoter-select');
  const polyASelect=document.getElementById('polyA-select');
  const leftHomology=document.getElementById('left-homology');
  const rightHomology=document.getElementById('right-homology');
  const barcodeInput=document.getElementById('barcode');

  const generateLibraryBtn=document.getElementById('generate-library-btn');
  const libraryOutputContainer=document.getElementById('library-output-container');
  const libraryOutputList=document.getElementById('library-output-list');
  const numCassettesInput=document.getElementById('num-cassettes');
  const numModulesInput=document.getElementById('num-modules');
  const mcNlGenerate=document.getElementById('mc-nl-generate');

  const importBtn=document.getElementById('import-btn');
  const exportBtn=document.getElementById('export-btn');
  const importFileInput=document.getElementById('import-file-input');

  // Data
  let cassetteGenes=[];
  let cassetteTypes=[];
  let connectors=[];
  let isSequenceVisible=false;
  const MAX_GENES=5;

  const connectorTypes={
    'overexpression-overexpression':['P2A','T2A','E2A','F2A'],
    'overexpression-gRNA':['IRES','U6'],
    'gRNA-overexpression':['U6'],
    'gRNA-gRNA':['U6','H1'],
    'default':['P2A']
  };

  const functionPredictions={
    'BATF':'Promotes T cell memory formation and prevents exhaustion',
    'IRF4':'Enhances T cell effector function and cytokine production',
    'c-Jun':'Improves T cell activation and proliferation',
    'IL-21':'Promotes T cell proliferation and survival',
    'dnPD-1':'Blocks PD-1 checkpoint signaling',
    'BCL6':'Promotes T cell memory and prevents exhaustion',
    'KO:PDCD1':'Eliminates PD-1 checkpoint inhibition',
    'KO:CTLA4':'Removes CTLA-4 checkpoint inhibition',
    'KO:LAG3':'Disrupts LAG-3 checkpoint pathway',
    'KO:DGK':'Enhances TCR signaling strength',
    'KO:TET2':'Modulates epigenetic regulation',
    'KD:SOCS1':'Reduces suppression of cytokine signaling',
    'KD:CBLB':'Enhances T cell activation signaling',
    'KD:NFKBIA':'Increases NF-ÎºB signaling',
    'KD:TGFBR1':'Reduces TGF-Î² mediated suppression',
    'KU:IL2RA':'Increases IL-2 receptor expression',
    'KU:TBX21':'Promotes Th1 differentiation',
    'KU:IFNG':'Enhances IFN-Î³ production',
    'KU:GZMB':'Increases cytotoxic granzyme activity'
  };

  const geneSequences={
    'BATF':'ATGGCATCCAAGTACCTGGAGAAGATCAAG',
    'IRF4':'ATGGCCTCCAAGAAGATCCTGAAGAAG',
    'c-Jun':'ATGGAAACGACCTTCTATGACGATGCCCT',
    'IL-21':'ATGGAGACCCTTGAGGATGAGAAGTGG',
    'dnPD-1':'ATGGCCGCTCTGTGCCTGCTGGGC',
    'BCL6':'ATGGCGGACCTGCGCTCAGTGCGC',
    'KO:PDCD1':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KO:CTLA4':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KO:LAG3':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KO:DGK':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KO:TET2':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KD:SOCS1':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KD:CBLB':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KD:NFKBIA':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KD:TGFBR1':'GTTTAAGAGCTATGCTGGAAACAGC',
    'KU:IL2RA':'ATGGAGGTTCTGCTGACGTGCTG',
    'KU:TBX21':'ATGGGCATATGGAGAGAGAGGAG',
    'KU:IFNG':'ATGAAATATACAAGTTATATCTTGGCTTT',
    'KU:GZMB':'ATGGCTGATGATGACGCTGCTGCT'
  };

  const allGeneModules=document.querySelectorAll('.gene-module');

  function showLimitWarning(){
    limitWarning.style.display='block';
    setTimeout(()=>{limitWarning.style.display='none';},1500);
  }

  function addGene(gene,type){
    if(cassetteGenes.length>=MAX_GENES){showLimitWarning();return;}
    cassetteGenes.push(gene);
    cassetteTypes.push(type);
    if(cassetteGenes.length>1){
      connectors[cassetteGenes.length-2]=chooseDefaultConnector(cassetteTypes[cassetteTypes.length-2],cassetteTypes[cassetteTypes.length-1]);
    }
    renderConstruct(); updateCassetteString();
  }

  function chooseDefaultConnector(t1,t2){
    const key=`${t1}-${t2}`;
    return (connectorTypes[key]||connectorTypes['default'])[0];
  }

  function removeGene(index){
    cassetteGenes.splice(index,1);
    cassetteTypes.splice(index,1);
    connectors.splice(index,1);
    renderConstruct(); updateCassetteString();
  }

  function renderConstruct(){
    constructBuilder.innerHTML='';
    if(!cassetteGenes.length){
      constructBuilder.appendChild(Object.assign(document.createElement('div'),{className:'placeholder',textContent:'Select a module category, then drag genes here (max 5)'}));
      return;
    }
    cassetteGenes.forEach((g,i)=>{
      const div=document.createElement('div');
      div.className='gene-module';div.textContent=g;div.style.cursor='default';
      const rm=document.createElement('button');
      rm.className='gene-remove-btn';rm.textContent='Ã—';
      rm.addEventListener('click',()=>removeGene(i));
      div.appendChild(rm);
      constructBuilder.appendChild(div);
      if(i<cassetteGenes.length-1){
        const wrap=document.createElement('div');
        wrap.className='connector-wrapper';
        const label=document.createElement('span');
        label.className='connector-label';label.textContent='â†’';
        const sel=document.createElement('select');
        sel.className='connector-select';
        const key=`${cassetteTypes[i]}-${cassetteTypes[i+1]}`;
        (connectorTypes[key]||connectorTypes.default).forEach(c=>{
          const opt=document.createElement('option');opt.value=c;opt.textContent=c;
          if(connectors[i]===c) opt.selected=true;
          sel.appendChild(opt);
        });
        sel.addEventListener('change',()=>{connectors[i]=sel.value;updateCassetteString();});
        wrap.appendChild(label);wrap.appendChild(sel);
        constructBuilder.appendChild(wrap);
      }
    });
  }

  function updateCassetteString(){
    const parts=[];
    cassetteGenes.forEach((g,i)=>{
      parts.push(g);
      if(i<connectors.length && connectors[i]) parts.push(`[${connectors[i]}]`);
    });
    cassetteString.value=parts.join(' - ');
    buildPrediction();
    if(isSequenceVisible) buildSequence();
  }

  function buildPrediction(){
    if(!cassetteGenes.length){
      constructNameOutput.textContent='N/A';
      predictedFunctionOutput.textContent='Build a construct to see prediction.';
      return;
    }
    constructNameOutput.textContent=cassetteGenes.join('+').replace(/[:]/g,'_');
    const uniq=[...new Set(cassetteGenes)];
    const phrases=uniq.map(g=>functionPredictions[g]).filter(Boolean);
    let summary=phrases.slice(0,3).join('; ');
    if(phrases.length>3) summary+='; plus added effects.';
    if(!summary) summary='Custom combination â€“ requires empirical validation.';
    predictedFunctionOutput.textContent=summary;
  }

  function linkerSequence(name){
    switch(name){
      case 'P2A':return 'GGAAGCGGAGCTACTAACTTCAGCCTGCTGAAGCAGGCTGGAGACGTGGAGGAGAACCCT';
      case 'T2A':return 'GAGGGCAGAGGAAGTCTGCTAACATGCGGTGACGTGGAGGAGAACCCT';
      case 'E2A':return 'GAGGGCAGAGGAAGTCTTCTAACATGCGGTGACGTCGAGGAGAACCCT';
      case 'F2A':return 'GGAGCCGCTGCTGACGTCGAGGACGTCGAGGAGAACCCT';
      case 'IRES':return 'AGGTTGGCCGCCGCCGTTGTTGTTGGTTCC';
      case 'U6':return 'GAGGGCCTATTTCCCATGATTCCTTCATAT';
      case 'H1':return 'GAGTGTGATGGGAGGTTTAGGCGTAT';
      default:return 'GGG';
    }
  }

  function buildSequence(){
    let seq=[];
    if(leftHomology.value) seq.push(leftHomology.value.toUpperCase());
    seq.push(promoterSelect.value.toUpperCase());
    cassetteGenes.forEach((g,i)=>{
      seq.push(`[${g}]`);
      seq.push(geneSequences[g]||'NNN');
      if(i<connectors.length && connectors[i]){
        seq.push(`[${connectors[i]}]`);
        seq.push(linkerSequence(connectors[i]));
      }
    });
    seq.push(polyASelect.value.toUpperCase());
    if(rightHomology.value) seq.push(rightHomology.value.toUpperCase());
    if(barcodeInput.value) seq.push(`BARCODE(${barcodeInput.value})`);
    finalSequenceOutput.innerHTML=seq.map(c=>{
      if(c.startsWith('[')){
        const name=c.slice(1,-1);
        return `<span class="gene-seq" title="${name}">${c}</span>`;
      }
      return `<span class="gene-seq">${c}</span>`;
    }).join(' ');
  }

  // Drag logic
  document.querySelectorAll('.gene-module').forEach(m=>{
    m.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('gene',m.dataset.gene);
      e.dataTransfer.setData('type',m.dataset.type);
    });
  });
  constructBuilder.addEventListener('dragover',e=>e.preventDefault());
  constructBuilder.addEventListener('drop',e=>{
    e.preventDefault();
    const g=e.dataTransfer.getData('gene');
    const t=e.dataTransfer.getData('type');
    if(g) addGene(g,t||'overexpression');
  });

  // Module category toggling
  moduleToggles.forEach(t=>{
    t.addEventListener('click',()=>{
      const target=document.getElementById(t.dataset.target);
      const active=t.classList.contains('active');
      moduleToggles.forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.module-container').forEach(c=>c.classList.add('hidden'));
      if(!active){t.classList.add('active');target.classList.remove('hidden');}
    });
  });

  // Search
  // Remove LHC/Def.Autocompleter code and implement custom autocomplete
  // Custom autocomplete for gene search input using Fetch API
  // Enhanced autocomplete dropdown with keyboard navigation and better UX
  let searchTimeout;
  let autocompleteDropdown = null;
  let autocompleteItems = [];
  let selectedIndex = -1;

  function closeAutocompleteDropdown() {
    if (autocompleteDropdown) {
      autocompleteDropdown.remove();
      autocompleteDropdown = null;
      autocompleteItems = [];
      selectedIndex = -1;
    }
  }

  // HGNC gene name autocomplete helper
  const JSON_HDR = { headers: { "Accept": "application/json" } };
  const nameCache = new Map();

  /**
   * Returns [{symbol, name}] for a user query such as "bat" or an alias like "p53".
   */
  async function hgncSuggest(query) {
    if (query.length < 2) return [];

    // Use the generic /search/ endpoint to match symbols, names, and aliases
    const searchURL =
      `https://rest.genenames.org/search/${encodeURIComponent(query)}`;
    const sRes = await fetch(searchURL, JSON_HDR).then(r => r.json());
    const hits = (sRes.response?.docs || []).slice(0, 10);          // top 10 only

    // 2. hydrate each hit with the full name (parallel, but rate-safe)
    const promises = hits.map(async ({ hgnc_id, symbol }) => {
      if (nameCache.has(symbol)) return { symbol, name: nameCache.get(symbol), hgnc_id };

      const fURL = `https://rest.genenames.org/fetch/symbol/${encodeURIComponent(symbol)}`;
      const fRes = await fetch(fURL, JSON_HDR).then(r => r.json());
      const name = fRes.response?.docs?.[0]?.name || "(name unavailable)";
      nameCache.set(symbol, name);
      return { symbol, name, hgnc_id };
    });

    return Promise.all(promises);
  }

  geneSearchInput.addEventListener('input', function() {
    const query = this.value.trim();
    closeAutocompleteDropdown();
    clearTimeout(searchTimeout);

    if (query.length >= 2) {
      searchTimeout = setTimeout(async () => {
        const items = await hgncSuggest(query);
        if (!items.length) return;

        autocompleteDropdown = document.createElement('div');
        autocompleteDropdown.className = 'autocomplete-suggestions';
        autocompleteDropdown.style.position = 'absolute';
        autocompleteDropdown.style.background = '#fff';
        autocompleteDropdown.style.color = '#8C1515';
        autocompleteDropdown.style.border = '1px solid #ccc';
        autocompleteDropdown.style.borderRadius = '6px';
        autocompleteDropdown.style.zIndex = '10000';
        autocompleteDropdown.style.width = geneSearchInput.offsetWidth + 'px';
        autocompleteDropdown.style.maxHeight = '220px';
        autocompleteDropdown.style.overflowY = 'auto';
        autocompleteDropdown.style.left = geneSearchInput.getBoundingClientRect().left + window.scrollX + 'px';
        autocompleteDropdown.style.top = geneSearchInput.getBoundingClientRect().bottom + window.scrollY + 'px';
        autocompleteDropdown.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
        autocompleteDropdown.style.fontSize = '15px';
        autocompleteDropdown.style.padding = '4px 0';
        autocompleteItems = [];
        selectedIndex = -1;

        items.forEach(({ symbol, name, hgnc_id }, idx) => {
          const row = document.createElement('div');
          row.className = 'autocomplete-suggestion';
          row.textContent = `${symbol} â€” ${name} (${hgnc_id || ''})`;
          row.tabIndex = -1;
          row.style.transition = 'background 0.15s';
          row.addEventListener('mousedown', () => {
            geneSearchInput.value = symbol;
            closeAutocompleteDropdown();
            showNcbiAddPanel(symbol);
            filterGeneModules();
          });
          row.addEventListener('mouseenter', () => {
            setActiveItem(idx);
          });
          autocompleteDropdown.appendChild(row);
          autocompleteItems.push(row);
        });
        document.body.appendChild(autocompleteDropdown);
      }, 300);
    }
    filterGeneModules();
  });

  geneSearchInput.addEventListener('keydown', function(e) {
    if (!autocompleteDropdown || !autocompleteItems.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setActiveItem((selectedIndex + 1) % autocompleteItems.length);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setActiveItem((selectedIndex - 1 + autocompleteItems.length) % autocompleteItems.length);
    } else if (e.key === 'Enter') {
      if (selectedIndex >= 0 && autocompleteItems[selectedIndex]) {
        autocompleteItems[selectedIndex].dispatchEvent(new Event('mousedown'));
      }
    } else if (e.key === 'Escape') {
      closeAutocompleteDropdown();
    }
  });

  function setActiveItem(idx) {
    autocompleteItems.forEach((item, i) => {
      if (i === idx) {
        item.classList.add('active');
        item.style.background = '#f5eaea';
      } else {
        item.classList.remove('active');
        item.style.background = '';
      }
    });
    selectedIndex = idx;
  }

  geneSearchInput.addEventListener('blur', function() {
    setTimeout(closeAutocompleteDropdown, 150);
  });

  geneSearchInput.addEventListener('focus', function() {
    if (this.value.length >= 2) {
      this.dispatchEvent(new Event('input'));
    }
  });

  function showNcbiAddPanel(geneSymbol) {
    // Get selected perturbation types
    const selectedTypes = getSelectedPerturbationTypes();
    if (!selectedTypes.length) {
      ncbiAddPanel.style.display = 'none';
      return;
    }
    // Show a button for each selected type
    ncbiAddPanel.innerHTML = selectedTypes.map(type => {
      let label = '';
      switch(type) {
        case 'KO': label = `Add as KO: ${geneSymbol}`; break;
        case 'KI': label = `Add as KI: ${geneSymbol}`; break;
        case 'KD': label = `Add as KD: ${geneSymbol}`; break;
        case 'KU': label = `Add as KU: ${geneSymbol}`; break;
      }
      return `<button class="button" data-ncbi-gene="${geneSymbol}" data-ncbi-type="${type}" style="margin-right:8px;margin-bottom:4px;">${label}</button>`;
    }).join('');
    ncbiAddPanel.style.display = 'block';
  }

  ncbiAddPanel.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.ncbiGene && e.target.dataset.ncbiType) {
      const gene = e.target.dataset.ncbiGene;
      const type = e.target.dataset.ncbiType;
      let displayGene = gene;
      let moduleType = 'overexpression';
      if (type === 'KO') { displayGene = `KO:${gene}`; moduleType = 'gRNA'; }
      else if (type === 'KD') { displayGene = `KD:${gene}`; moduleType = 'gRNA'; }
      else if (type === 'KU') { displayGene = `KU:${gene}`; moduleType = 'overexpression'; }
      // KI is just the gene name, overexpression
      addGene(displayGene, moduleType);
      ncbiAddPanel.style.display = 'none';
      lastNcbiGene = null;
      document.getElementById('gene-search-input').value = '';
    }
  });

  // Hide NCBI add panel if search input changes
  geneSearchInput.addEventListener('input',()=>{
    filterGeneModules();
    if (lastNcbiGene && geneSearchInput.value.trim() !== lastNcbiGene) {
      ncbiAddPanel.style.display = 'none';
      lastNcbiGene = null;
    }
  });

  // Perturbation type toggles logic
  document.querySelectorAll('.perturbation-type-toggle').forEach(cb=>{
    cb.addEventListener('change',()=>{
      filterGeneModules();
    });
  });

  function getSelectedPerturbationTypes(){
    return Array.from(document.querySelectorAll('.perturbation-type-toggle:checked')).map(cb=>cb.value);
  }

  function getGenePerturbationType(gene, type) {
    // type is the data-type attribute ("overexpression" or "gRNA")
    if(type === 'gRNA') {
      if(gene.startsWith('KO:')) return 'KO';
      if(gene.startsWith('KD:')) return 'KD';
    } else if(type === 'overexpression') {
      if(gene.startsWith('KU:')) return 'KU';
      // KI is default overexpression that is not KU
      return 'KI';
    }
    return '';
  }

  function filterGeneModules() {
    const q = geneSearchInput.value.toLowerCase();
    const selectedTypes = getSelectedPerturbationTypes();
    let anyVisible = false;
    document.querySelectorAll('.gene-module').forEach(g => {
      const gene = g.dataset.gene;
      const type = g.dataset.type;
      const pertType = getGenePerturbationType(gene, type);
      const matchesType = selectedTypes.includes(pertType);
      const matchesSearch = gene.toLowerCase().includes(q);
      const show = (matchesType && matchesSearch);
      g.style.display = show ? 'inline-block' : 'none';
      if (show) anyVisible = true;
    });
    document.getElementById('no-gene-results').style.display = anyVisible ? 'none' : 'block';
  }

  // Randomize (respect limit)
  randomizeBtn.addEventListener('click',()=>{
    resetCassette();
    const pool=[...document.querySelectorAll('.gene-module')];
    const count=Math.min(3,MAX_GENES,pool.length);
    for(let i=0;i<count;i++){
      const idx=Math.floor(Math.random()*pool.length);
      const el=pool.splice(idx,1)[0];
      addGene(el.dataset.gene,el.dataset.type);
    }
  });

  function resetCassette(){
    cassetteGenes=[];cassetteTypes=[];connectors=[];
    renderConstruct();updateCassetteString();if(isSequenceVisible) buildSequence();
  }
  resetBtn.addEventListener('click',resetCassette);

  // Export / Import
  exportBtn.addEventListener('click',()=>{
    const data={
      cassetteGenes,cassetteTypes,connectors,
      promoter:promoterSelect.value,polyA:polyASelect.value,
      left:leftHomology.value,right:rightHomology.value,barcode:barcodeInput.value
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='cassette.json';a.click();URL.revokeObjectURL(a.href);
  });
  importBtn.addEventListener('click',()=>importFileInput.click());
  importFileInput.addEventListener('change',e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const obj=JSON.parse(reader.result);
        cassetteGenes=(obj.cassetteGenes||[]).slice(0,MAX_GENES);
        cassetteTypes=obj.cassetteTypes||cassetteGenes.map(()=> 'overexpression');
        connectors=obj.connectors||[];
        promoterSelect.value=obj.promoter||'EF1a';
        polyASelect.value=obj.polyA||'SV40';
        leftHomology.value=obj.left||'';
        rightHomology.value=obj.right||'';
        barcodeInput.value=obj.barcode||'';
        renderConstruct();updateCassetteString();
      }catch(err){alert('Invalid file');}
    };
    reader.readAsText(file);
  });

  // Sequence toggle
  toggleSequenceBtn.addEventListener('click',()=>{
    isSequenceVisible=!isSequenceVisible;
    toggleSequenceBtn.textContent=isSequenceVisible?'Hide Sequence':'Show Sequence';
    finalConstructDetails.classList.toggle('hidden',!isSequenceVisible);
    if(isSequenceVisible) buildSequence();
  });

  [promoterSelect,polyASelect,leftHomology,rightHomology,barcodeInput].forEach(el=>{
    el.addEventListener('input',()=>{if(isSequenceVisible) buildSequence();});
  });

  // Global mode switching
  modeToggles.forEach(r=>{
    r.addEventListener('change',()=>{
      const mode=document.querySelector('input[name="design-mode"]:checked').value;
      naturalLanguageContainer.classList.toggle('hidden',mode!=='natural');
      manualToolContainer.classList.toggle('hidden',mode!=='manual');
      multiCassetteToolContainer.classList.toggle('hidden',mode!=='multi');
    });
  });

  // Multi-cassette internal mode
  mcModeToggles.forEach(r=>{
    r.addEventListener('change',()=>{
      const mode=document.querySelector('input[name="mc-mode"]:checked').value;
      mcManualPanel.classList.toggle('hidden',mode!=='manual');
      mcNlPanel.classList.toggle('hidden',mode!=='nl');
    });
  });

  // Natural language (single construct)
  naturalLanguageInput.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      const val=naturalLanguageInput.value.trim();
      if(!val) return;
      reasoningDisplay.classList.remove('hidden');
      setTimeout(()=>{
        reasoningDisplay.classList.add('hidden');
        applyNL(val);
        naturalLanguageInput.value='';
      },1200);
    }
  });

  function applyNL(text){
    resetCassette();
    const picks=[];
    if(/memory/i.test(text)) picks.push('BATF','BCL6');
    if(/activation|proliferation|stimulat/i.test(text)) picks.push('c-Jun','IL-21');
    if(/checkpoint|exhaust/i.test(text)) picks.push('dnPD-1','KO:PDCD1');
    if(/cytotox|kill|granzyme/i.test(text)) picks.push('KU:GZMB','KU:IFNG');
    if(!picks.length) picks.push('BATF','IL-21','KO:PDCD1');
    [...new Set(picks)].slice(0,MAX_GENES).forEach(g=>{
      const el=[...allGeneModules].find(m=>m.dataset.gene===g);
      addGene(g, el?el.dataset.type:'overexpression');
    });
  }

  // Multi-cassette manual generation
  generateLibraryBtn.addEventListener('click',()=>{
    generateLibrary('manual');
  });

  mcNlGenerate.addEventListener('click',()=>{
    generateLibrary('nl', mcNlInput.value.trim());
  });

  function generateLibrary(mode, nlText=''){
    const n=parseInt(numCassettesInput.value)||1;
    let m=parseInt(numModulesInput.value)||1;
    if(m>MAX_GENES) m=MAX_GENES;
    let pools=[];
    if(mode==='manual'){
      if(document.getElementById('include-ki').checked) pools.push(...document.querySelectorAll('#knock-in-modules .gene-module'));
      if(document.getElementById('include-ko').checked) pools.push(...document.querySelectorAll('#knock-out-modules .gene-module'));
      if(document.getElementById('include-kd').checked) pools.push(...document.querySelectorAll('#knock-down-modules .gene-module'));
      if(document.getElementById('include-ku').checked) pools.push(...document.querySelectorAll('#knock-up-modules .gene-module'));
    } else {
      // bias selection using NL descriptors
      const themes=[];
      if(/memory/i.test(nlText)) themes.push('BATF','BCL6');
      if(/checkpoint|exhaust/i.test(nlText)) themes.push('dnPD-1','KO:PDCD1','KO:CTLA4');
      if(/cytotox|granzyme|kill/i.test(nlText)) themes.push('KU:GZMB','KU:IFNG');
      if(/activation|prolifer/i.test(nlText)) themes.push('c-Jun','IL-21');
      if(!themes.length) themes.push('BATF','IL-21','KO:PDCD1','KU:GZMB');
      pools=[...new Set(themes)].map(g=>[...allGeneModules].find(m=>m.dataset.gene===g)).filter(Boolean);
    }
    if(!pools.length){alert('No perturbation types selected');return;}
    libraryOutputList.innerHTML='';
    for(let i=0;i<n;i++){
      const genes=[],types=[];
      const localPool=[...pools];
      for(let j=0;j<m;j++){
        const pick=localPool[Math.floor(Math.random()*localPool.length)];
        genes.push(pick.dataset.gene);
        types.push(pick.dataset.type);
      }
      const li=document.createElement('li');
      li.textContent=genes.join(' - ');
      li.dataset.genes=JSON.stringify(genes);
      li.dataset.types=JSON.stringify(types);
      li.addEventListener('click',()=>{
        cassetteGenes=genes.slice(0,MAX_GENES);
        cassetteTypes=types.slice(0,MAX_GENES);
        connectors=[];
        for(let k=0;k<cassetteGenes.length-1;k++){
          connectors[k]=chooseDefaultConnector(cassetteTypes[k],cassetteTypes[k+1]);
        }
        renderConstruct();updateCassetteString();
        document.getElementById('manual-mode').checked=true;
        manualToolContainer.classList.remove('hidden');
        multiCassetteToolContainer.classList.add('hidden');
        naturalLanguageContainer.classList.add('hidden');
      });
      libraryOutputList.appendChild(li);
    }
    libraryOutputContainer.classList.remove('hidden');
  }

  // Init
  renderConstruct();updateCassetteString();
});
</script>
</body>
</html>
